name: Cost-Optimized Deploy to Google Cloud

on:
  push:
    branches: [ main, master ]
    # Only deploy if certain files changed to avoid unnecessary deployments
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'app.yaml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Allow manual deployment

# Cancel in-progress deployments if a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job to check if deployment is needed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for significant changes
      id: changes
      run: |
        # Check if this is a docs-only change
        if git diff --name-only HEAD~1 HEAD | grep -qvE '\.(md|txt)$|^\.github/(?!workflows)'; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        fi

  build-and-deploy:
    needs: check-changes
    # Always run for manual dispatch, otherwise check for significant changes
    if: github.event_name == 'workflow_dispatch' || needs.check-changes.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js (with caching)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        CI: true
        VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        
    - name: Verify build output
      run: |
        echo "Build output:"
        ls -lah dist/
        echo "Total size:"
        du -sh dist/
        echo "Top 10 largest files:"
        find dist -type f -name "*.js" -o -name "*.css" | xargs ls -lah | sort -k5 -hr | head -10
        
    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: Configure gcloud for cost optimization
      run: |
        # Set default region to reduce costs
        gcloud config set compute/region us-central1
        gcloud config set app/promote_by_default false
        
    - name: Deploy to App Engine (with cache clearing)
      run: |
        # Create version ID with timestamp for cache busting
        VERSION_ID=$(date +%Y%m%d-%H%M%S)
        echo "Deploying version: $VERSION_ID"
        
        # Deploy new version
        gcloud app deploy app.yaml \
          --version=$VERSION_ID \
          --no-promote \
          --quiet \
          --verbosity=warning
        
        # Always promote immediately to clear caches and show latest version
        echo "Promoting new version and clearing caches..."
        gcloud app services set-traffic default --splits=$VERSION_ID=100 --quiet
        
        # Wait a moment for traffic to switch
        sleep 5
        
        echo "✓ Version $VERSION_ID promoted successfully"
        echo "Cache cleared - users will see the new version on next page load"
        
        # Clean up old versions to save storage costs (keep last 3)
        echo "Cleaning up old versions..."
        gcloud app versions list --service=default --format="value(id)" --sort-by="~createTime" | tail -n +4 | xargs -r gcloud app versions delete --quiet --service=default || echo "No old versions to delete"
        
    - name: Verify deployment
      run: |
        # Get the app URL
        APP_URL=$(gcloud app describe --format="value(defaultHostname)")
        echo "Application deployed to: https://$APP_URL"
        
        # Basic health check
        curl -f -s "https://$APP_URL" > /dev/null && echo "✓ App is responding" || echo "⚠ App health check failed"

  # Notification job (only runs if deployment fails)
  notify-on-failure:
    needs: build-and-deploy
    if: failure()
    runs-on: ubuntu-latest
    steps:
    - name: Notify on failure
      run: |
        echo "Deployment failed. Check the logs at:"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
