runtime: nodejs20
service: default

# Cost-optimized instance configuration
instance_class: F1  # Smallest instance class for minimal cost

# Automatic scaling configuration for cost optimization
automatic_scaling:
  min_instances: 0              # Scale to zero when no traffic (saves money)
  max_instances: 3              # Limit max instances to control costs
  target_cpu_utilization: 0.70 # Higher utilization threshold
  target_throughput_utilization: 0.80
  min_pending_latency: 1s       # Allow some latency to reduce instances
  max_pending_latency: 15s

# Environment variables
env_variables:
  NODE_ENV: production

# Health check configuration - optimized for cost
liveness_check:
  path: "/"
  check_interval_sec: 60        # Longer intervals to reduce overhead
  timeout_sec: 10
  failure_threshold: 3          # Allow more failures before restart
  success_threshold: 1

readiness_check:
  path: "/"
  check_interval_sec: 15
  timeout_sec: 10
  failure_threshold: 3
  success_threshold: 1

# Static file handling - optimized for cache busting
handlers:
# Cache hashed assets (with version in filename) for a year
# Vite adds hashes to filenames, so these are safe to cache forever
- url: /assets/(.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot))
  static_files: dist/assets/\1
  upload: dist/assets/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)
  secure: always
  expiration: "365d"
  http_headers:
    Cache-Control: "public, max-age=31536000, immutable"
    X-Content-Type-Options: "nosniff"

# Cache other assets for a shorter time
- url: /assets
  static_dir: dist/assets
  secure: always
  expiration: "1d"
  http_headers:
    Cache-Control: "public, max-age=86400"
  
# Main HTML - NEVER cache to ensure users always get latest version
- url: /.*
  static_files: dist/index.html
  upload: dist/index.html
  secure: always
  http_headers:
    Cache-Control: "no-cache, no-store, must-revalidate, max-age=0"
    Pragma: "no-cache"
    Expires: "0"
